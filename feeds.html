<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FakeBook - Feed</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body { 
    font-family: Arial, sans-serif; 
    background: #f0f2f5; 
    color: #333;
    font-size: 18px;
}

header { 
    background: #1877f2; 
    color: white; 
    padding: 20px; 
    font-size: 28px;
    text-align: center;
}

nav {
    background: white; 
    padding: 15px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

nav a {
    margin: 0 15px;
    color: #1877f2;
    text-decoration: none;
    font-size: 18px;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background 0.3s;
}

nav a:hover {
    background: #f0f2f5;
}

.container {
    max-width: 700px;
    margin: 30px auto;
    padding: 0 20px;
}

.post-form {
    background: white;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.post-form h3 {
    font-size: 22px;
    color: #1877f2;
    margin-bottom: 15px;
}

.post-form textarea, .post-form input, .post-form select {
    width: 100%;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 18px;
}

.post-form button {
    background: #1877f2;
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 500;
    transition: background 0.3s;
}

.post-form button:hover {
    background: #166fe5;
}

.post {
    background: white;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.post-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.post-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #1877f2;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    margin-right: 15px;
}

.post-author {
    flex: 1;
}

.post-author-name {
    font-weight: bold;
    font-size: 18px;
    color: #1877f2;
}

.post-author-time {
    color: #666;
    font-size: 14px;
}

.post-content {
    margin: 20px 0;
    font-size: 18px;
    line-height: 1.5;
}

.post-media {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 15px;
}

.post-actions {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 15px;
}

.post-actions button {
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-like {
    background: #f0f2f5;
    color: #1877f2;
}

.btn-like:hover {
    background: #e7f3ff;
}

.btn-comment {
    background: #f0f2f5;
    color: #1877f2;
}

.btn-comment:hover {
    background: #e7f3ff;
}

.comments-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.comments-section h4 {
    font-size: 18px;
    color: #333;
    margin-bottom: 15px;
}

.comment-form {
    margin-bottom: 20px;
}

.comment-form textarea {
    width: 100%;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 16px;
    margin-bottom: 10px;
    resize: vertical;
}

.comment-form button {
    padding: 10px 20px;
    background: #1877f2;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
}

.comment-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.comment-item {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.comment-author {
    font-weight: bold;
    color: #1877f2;
    font-size: 16px;
}

.comment-time {
    color: #666;
    font-size: 14px;
}

.comment-content {
    font-size: 16px;
    line-height: 1.5;
}

.empty-comments {
    text-align: center;
    padding: 20px;
    color: #666;
    font-size: 16px;
}
</style>
</head>
<body>

<header>FakeBook Feed</header>
<nav>
    <a href="index.html">Lar</a>
    <a href="feed.html">Feed</a>
    <a href="profile.html">Perfil</a>
    <a href="friends.html">Amigos</a>
    <a href="login.html">Logout</a>
</nav>

<div class="container">
    <!-- FORMUL츼RIO DE POST -->
    <div class="post-form">
        <h3>游닇 Novo Post</h3>
        <textarea id="post-content" placeholder="No que voc칡 est치 pensando?" rows="4"></textarea>
        <input type="text" id="post-media" placeholder="URL de m칤dia (opcional)">
        <select id="post-type">
            <option value="texto">Texto</option>
            <option value="imagem">Imagem</option>
            <option value="video">V칤deo</option>
        </select>
        <select id="post-privacy">
            <option value="publico">P칰blico</option>
            <option value="amigos">Amigos</option>
            <option value="privado">Privado</option>
        </select>
        <button onclick="createPost()">Postar</button>
    </div>

    <!-- FEED DE POSTS -->
    <h3>游닗 Feed</h3>
    <div id="feed"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://umzlriwvexvaabliriva.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtemxyaXd2ZXh2YWFibGlyaXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NjEwMjQsImV4cCI6MjA4MDQzNzAyNH0.8miF7Z0e2sTduJhveCk-6GKzroS0CYF-PS6BZeEKpEI";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const user_id = localStorage.getItem('user_id');
if(!user_id) { 
    alert('Fa칞a login primeiro!');
    window.location.href = 'login.html'; 
}

// VARI츼VEL PARA CONTROLAR COMENT츼RIOS ABERTOS
let openCommentPostId = null;

// CRIAR POST
async function createPost() {
    const conteudo = document.getElementById('post-content').value.trim();
    const midia_url = document.getElementById('post-media').value.trim();
    const tipo = document.getElementById('post-type').value;
    const privacidade = document.getElementById('post-privacy').value;
    
    if(!conteudo && !midia_url) {
        alert('Digite algo ou insira uma m칤dia!');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('posts')
            .insert([{
                user_id: user_id,
                conteudo: conteudo,
                midia_url: midia_url || null,
                tipo: tipo,
                privacidade: privacidade,
                criado_em: new Date().toISOString()
            }]);
        
        if (error) {
            console.error('Erro ao criar post:', error);
            alert('Erro ao criar post: ' + error.message);
            return;
        }
        
        alert('Post criado com sucesso!');
        document.getElementById('post-content').value = '';
        document.getElementById('post-media').value = '';
        loadFeed();
        
    } catch (err) {
        console.error('Erro inesperado:', err);
        alert('Erro inesperado ao criar post');
    }
}

// CARREGAR FEED
async function loadFeed() {
    const feed = document.getElementById('feed');
    feed.innerHTML = '<p>Carregando posts...</p>';
    
    try {
        // CARREGA POSTS COM INFORMA칂칏ES DO USU츼RIO
        const { data: posts, error: postsError } = await supabase
            .from('posts')
            .select(`
                id,
                conteudo,
                midia_url,
                tipo,
                privacidade,
                criado_em,
                user_id,
                users!left(nome, sobrenome, username)
            `)
            .order('criado_em', { ascending: false })
            .limit(20);
        
        if (postsError) {
            console.error('Erro ao carregar posts:', postsError);
            feed.innerHTML = '<p>Erro ao carregar posts</p>';
            return;
        }
        
        if (!posts || posts.length === 0) {
            feed.innerHTML = '<p>Nenhum post encontrado. Seja o primeiro a postar!</p>';
            return;
        }
        
        feed.innerHTML = '';
        
        // PARA CADA POST
        for (const post of posts) {
            // BUSCA CONTAGEM DE LIKES
            const { count: likesCount } = await supabase
                .from('post_likes')
                .select('id', { count: 'exact', head: true })
                .eq('post_id', post.id);
            
            // BUSCA COMENT츼RIOS DESTE POST
            const { data: comments, error: commentsError } = await supabase
                .from('comments')
                .select(`
                    id,
                    conteudo,
                    criado_em,
                    user_id,
                    users!inner(nome, sobrenome, username)
                `)
                .eq('post_id', post.id)
                .order('criado_em', { ascending: true });
            
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            postDiv.id = `post-${post.id}`;
            
            const userName = post.users ? 
                `${post.users.nome || ''} ${post.users.sobrenome || ''}`.trim() || 
                post.users.username || 'Usu치rio Desconhecido' : 
                'Usu치rio Desconhecido';
            
            const firstLetter = userName.charAt(0).toUpperCase();
            const postDate = new Date(post.criado_em).toLocaleString('pt-BR');
            
            // M칈DIA DO POST
            let mediaHtml = '';
            if (post.midia_url) {
                if (post.tipo === 'imagem') {
                    mediaHtml = `<img src="${post.midia_url}" alt="Imagem" class="post-media" onerror="this.style.display='none'">`;
                } else if (post.tipo === 'video') {
                    mediaHtml = `<video src="${post.midia_url}" controls class="post-media"></video>`;
                } else {
                    mediaHtml = `<img src="${post.midia_url}" alt="M칤dia" class="post-media" onerror="this.style.display='none'">`;
                }
            }
            
            // COMENT츼RIOS DO POST
            let commentsHtml = '';
            if (comments && comments.length > 0) {
                commentsHtml = '<div class="comment-list">';
                comments.forEach(comment => {
                    const commentUserName = comment.users ? 
                        `${comment.users.nome || ''} ${comment.users.sobrenome || ''}`.trim() || 
                        comment.users.username || 'Usu치rio' : 
                        'Usu치rio';
                    const commentDate = new Date(comment.criado_em).toLocaleString('pt-BR');
                    
                    commentsHtml += `
                        <div class="comment-item">
                            <div class="comment-header">
                                <div class="comment-author">${commentUserName}</div>
                                <div class="comment-time">${commentDate}</div>
                            </div>
                            <div class="comment-content">${comment.conteudo || ''}</div>
                        </div>
                    `;
                });
                commentsHtml += '</div>';
            } else {
                commentsHtml = '<div class="empty-comments">Nenhum coment치rio ainda</div>';
            }
            
            // FORMUL츼RIO DE COMENT츼RIO (inicialmente escondido)
            const commentFormHtml = openCommentPostId === post.id ? `
                <div class="comment-form">
                    <textarea id="comment-text-${post.id}" placeholder="Digite seu coment치rio..." rows="3"></textarea>
                    <button onclick="submitComment(${post.id})">Comentar</button>
                    <button onclick="cancelComment(${post.id})" style="background:#6c757d; margin-left:10px;">Cancelar</button>
                </div>
            ` : '';
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar">${firstLetter}</div>
                    <div class="post-author">
                        <div class="post-author-name">${userName}</div>
                        <div class="post-author-time">${postDate}</div>
                    </div>
                </div>
                <div class="post-content">${post.conteudo || ''}</div>
                ${mediaHtml}
                <div class="post-actions">
                    <button class="btn-like" onclick="likePost(${post.id})">
                        游녨 Curtir (${likesCount || 0})
                    </button>
                    <button class="btn-comment" onclick="toggleCommentForm(${post.id})">
                        游눫 Comentar (${comments ? comments.length : 0})
                    </button>
                </div>
                <div class="comments-section">
                    <h4>游눫 Coment치rios</h4>
                    ${commentFormHtml}
                    ${commentsHtml}
                </div>
            `;
            
            feed.appendChild(postDiv);
        }
        
    } catch (err) {
        console.error('Erro inesperado:', err);
        feed.innerHTML = '<p>Erro inesperado ao carregar feed</p>';
    }
}

// CURTIR POST
async function likePost(postId) {
    try {
        // VERIFICA SE J츼 CURTIU
        const { data: existingLike } = await supabase
            .from('post_likes')
            .select('id')
            .eq('post_id', postId)
            .eq('user_id', user_id)
            .single();
        
        if (existingLike) {
            // REMOVE LIKE
            const { error } = await supabase
                .from('post_likes')
                .delete()
                .eq('id', existingLike.id);
            
            if (!error) {
                alert('Like removido!');
                loadFeed();
            }
        } else {
            // ADICIONA LIKE
            const { error } = await supabase
                .from('post_likes')
                .insert([{
                    post_id: postId,
                    user_id: user_id,
                    tipo: 'curtir'
                }]);
            
            if (!error) {
                alert('Post curtido!');
                loadFeed();
            }
        }
    } catch (err) {
        console.error('Erro ao curtir:', err);
        alert('Erro ao curtir post');
    }
}

// MOSTRAR/OCULTAR FORMUL츼RIO DE COMENT츼RIO
function toggleCommentForm(postId) {
    if (openCommentPostId === postId) {
        openCommentPostId = null;
    } else {
        openCommentPostId = postId;
    }
    loadFeed();
}

// CANCELAR COMENT츼RIO
function cancelComment(postId) {
    openCommentPostId = null;
    loadFeed();
}

// ENVIAR COMENT츼RIO
async function submitComment(postId) {
    const commentText = document.getElementById(`comment-text-${postId}`).value.trim();
    
    if (!commentText) {
        alert('Digite um coment치rio!');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('comments')
            .insert([{
                post_id: postId,
                user_id: user_id,
                conteudo: commentText,
                criado_em: new Date().toISOString()
            }]);
        
        if (error) {
            console.error('Erro ao comentar:', error);
            alert('Erro ao adicionar coment치rio: ' + error.message);
            return;
        }
        
        alert('Coment치rio adicionado!');
        openCommentPostId = null;
        loadFeed();
        
    } catch (err) {
        console.error('Erro inesperado:', err);
        alert('Erro ao adicionar coment치rio');
    }
}

// CARREGA O FEED QUANDO A P츼GINA ABRIR
window.addEventListener('DOMContentLoaded', loadFeed);
</script>

</body>
</html>
