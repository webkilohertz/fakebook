<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FakeBook - Amigos</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body { 
    font-family: Arial, sans-serif; 
    background: #f0f2f5; 
    color: #333;
    font-size: 18px;
}

header { 
    background: #1877f2; 
    color: white; 
    padding: 20px; 
    font-size: 28px;
    text-align: center;
}

nav {
    background: white; 
    padding: 15px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

nav a {
    margin: 0 15px;
    color: #1877f2;
    text-decoration: none;
    font-size: 18px;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background 0.3s;
}

nav a:hover {
    background: #f0f2f5;
}

.container {
    max-width: 800px;
    margin: 30px auto;
    padding: 0 20px;
}

.section {
    background: white;
    padding: 25px;
    border-radius: 15px;
    margin-bottom: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

h2 {
    font-size: 24px;
    color: #1877f2;
    margin-bottom: 20px;
}

.add-friend {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.add-friend input {
    flex: 1;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 18px;
}

.add-friend button {
    padding: 15px 25px;
    border: none;
    border-radius: 8px;
    background: #1877f2;
    color: white;
    cursor: pointer;
    font-size: 18px;
    font-weight: 500;
}

.add-friend button:hover {
    background: #166fe5;
}

.friend-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.friend-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px;
    background: #f8f9fa;
    border-radius: 10px;
    border: 1px solid #e4e6eb;
}

.friend-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.friend-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #1877f2;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
}

.friend-details {
    flex: 1;
}

.friend-name {
    font-weight: bold;
    font-size: 18px;
    color: #1877f2;
}

.friend-username {
    color: #65676b;
    font-size: 16px;
}

.friend-status {
    font-size: 14px;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 500;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-accepted {
    background: #d4edda;
    color: #155724;
}

.friend-actions {
    display: flex;
    gap: 10px;
}

button {
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-accept {
    background: #42b72a;
    color: white;
}

.btn-accept:hover {
    background: #36a420;
}

.btn-reject {
    background: #f02849;
    color: white;
}

.btn-reject:hover {
    background: #e02445;
}

.btn-remove {
    background: #dc3545;
    color: white;
}

.btn-remove:hover {
    background: #c82333;
}

.btn-cancel {
    background: #6c757d;
    color: white;
}

.btn-cancel:hover {
    background: #5a6268;
}

.empty-message {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 18px;
}

.friend-stats {
    display: flex;
    gap: 20px;
    margin: 20px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
}

.stat-item {
    text-align: center;
    flex: 1;
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    color: #1877f2;
}

.stat-label {
    font-size: 14px;
    color: #65676b;
    margin-top: 5px;
}
</style>
</head>
<body>

<header>FakeBook - Amigos</header>
<nav>
  <a href="feed.html">Feed</a>
  <a href="profile.html">Perfil</a>
  <a href="friends.html">Amigos</a>
  <a href="groups.html">Grupos</a>
  <a href="pages.html">P√°ginas</a>
  <a href="media.html">M√≠dia</a>
  <a href="stories.html">Stories</a>
  <a href="settings.html">Configura√ß√µes</a>
  <a href="login.html">Logout</a>
</nav>

<div class="container">
    <!-- ADICIONAR AMIGO -->
    <div class="section">
        <h2>üë• Adicionar Amigo</h2>
        <div class="add-friend">
            <input type="text" id="friendUsername" placeholder="Digite o nome de usu√°rio">
            <button onclick="addFriend()">Enviar Solicita√ß√£o</button>
        </div>
    </div>
    
    <!-- ESTAT√çSTICAS -->
    <div class="section">
        <div class="friend-stats">
            <div class="stat-item">
                <div class="stat-value" id="friends-count">0</div>
                <div class="stat-label">Amigos</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="pending-count">0</div>
                <div class="stat-label">Solicita√ß√µes Pendentes</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="sent-count">0</div>
                <div class="stat-label">Solicita√ß√µes Enviadas</div>
            </div>
        </div>
    </div>
    
    <!-- SOLICITA√á√ïES PENDENTES -->
    <div class="section">
        <h2>üì® Solicita√ß√µes Pendentes</h2>
        <div id="pending-friends" class="friend-list">
            <div class="empty-message">Carregando solicita√ß√µes...</div>
        </div>
    </div>
    
    <!-- SEUS AMIGOS -->
    <div class="section">
        <h2>ü§ù Seus Amigos</h2>
        <div id="friends-list" class="friend-list">
            <div class="empty-message">Carregando amigos...</div>
        </div>
    </div>
    
    <!-- SOLICITA√á√ïES ENVIADAS -->
    <div class="section">
        <h2>üì§ Solicita√ß√µes Enviadas</h2>
        <div id="sent-requests" class="friend-list">
            <div class="empty-message">Carregando solicita√ß√µes enviadas...</div>
        </div>
    </div>
</div>

<!-- MESMO CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://umzlriwvexvaabliriva.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtemxyaXd2ZXh2YWFibGlyaXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NjEwMjQsImV4cCI6MjA4MDQzNzAyNH0.8miF7Z0e2sTduJhveCk-6GKzroS0CYF-PS6BZeEKpEI";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const user_id = localStorage.getItem('user_id');
if(!user_id) { 
    alert('Fa√ßa login primeiro!');
    window.location.href = 'login.html'; 
}

// ADICIONAR AMIGO
async function addFriend() {
    const username = document.getElementById('friendUsername').value.trim();
    
    if (!username) {
        alert('Digite o nome de usu√°rio');
        return;
    }
    
    if (username === localStorage.getItem('user_name')) {
        alert('Voc√™ n√£o pode adicionar a si mesmo!');
        return;
    }
    
    try {
        // BUSCA O USU√ÅRIO
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('id, nome, username')
            .eq('username', username)
            .single();
        
        if (userError || !userData) {
            alert('Usu√°rio n√£o encontrado');
            return;
        }
        
        const friend_id = userData.id;
        
        // VERIFICA SE J√Å EXISTE SOLICITA√á√ÉO
        const { data: existingRequest } = await supabase
            .from('friends')
            .select('id, status')
            .or(`and(user_id.eq.${user_id},friend_id.eq.${friend_id}),and(user_id.eq.${friend_id},friend_id.eq.${user_id})`)
            .single();
        
        if (existingRequest) {
            if (existingRequest.status === 'pendente') {
                alert('J√° existe uma solicita√ß√£o pendente com este usu√°rio');
            } else if (existingRequest.status === 'aceito') {
                alert('Voc√™ j√° √© amigo deste usu√°rio');
            } else {
                alert('J√° existe uma conex√£o com este usu√°rio');
            }
            return;
        }
        
        // ENVIA SOLICITA√á√ÉO
        const { error } = await supabase
            .from('friends')
            .insert([{
                user_id: user_id,
                friend_id: friend_id,
                status: 'pendente'
            }]);
        
        if (error) {
            alert('Erro ao enviar solicita√ß√£o: ' + error.message);
            return;
        }
        
        alert(`Solicita√ß√£o enviada para ${userData.nome} (@${userData.username})!`);
        document.getElementById('friendUsername').value = '';
        loadFriends();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao enviar solicita√ß√£o');
    }
}

// CARREGAR AMIGOS
async function loadFriends() {
    try {
        // SOLICITA√á√ïES PENDENTES (recebidas)
        const { data: pendingRequests, error: pendingError } = await supabase
            .from('friends')
            .select(`
                id,
                user_id,
                friend_id,
                status,
                criado_em,
                users!friends_user_id_fkey(nome, sobrenome, username)
            `)
            .eq('friend_id', user_id)
            .eq('status', 'pendente')
            .order('criado_em', { ascending: false });
        
        // AMIGOS ACEITOS
        const { data: acceptedFriends, error: friendsError } = await supabase
            .from('friends')
            .select(`
                id,
                user_id,
                friend_id,
                status,
                criado_em,
                users!friends_user_id_fkey(nome, sobrenome, username),
                users!friends_friend_id_fkey(nome, sobrenome, username)
            `)
            .or(`user_id.eq.${user_id},friend_id.eq.${user_id}`)
            .eq('status', 'aceito')
            .order('criado_em', { ascending: false });
        
        // SOLICITA√á√ïES ENVIADAS (pendentes que voc√™ enviou)
        const { data: sentRequests, error: sentError } = await supabase
            .from('friends')
            .select(`
                id,
                user_id,
                friend_id,
                status,
                criado_em,
                users!friends_friend_id_fkey(nome, sobrenome, username)
            `)
            .eq('user_id', user_id)
            .eq('status', 'pendente')
            .order('criado_em', { ascending: false });
        
        if (pendingError || friendsError || sentError) {
            console.error('Erro ao carregar amigos:', pendingError || friendsError || sentError);
            alert('Erro ao carregar lista de amigos');
            return;
        }
        
        // ATUALIZA ESTAT√çSTICAS
        document.getElementById('friends-count').textContent = acceptedFriends ? acceptedFriends.length : 0;
        document.getElementById('pending-count').textContent = pendingRequests ? pendingRequests.length : 0;
        document.getElementById('sent-count').textContent = sentRequests ? sentRequests.length : 0;
        
        // RENDERIZA SOLICITA√á√ïES PENDENTES
        const pendingDiv = document.getElementById('pending-friends');
        if (!pendingRequests || pendingRequests.length === 0) {
            pendingDiv.innerHTML = '<div class="empty-message">Nenhuma solicita√ß√£o pendente</div>';
        } else {
            pendingDiv.innerHTML = '';
            pendingRequests.forEach(request => {
                const friendDiv = createFriendItem(
                    request.users,
                    'pendente',
                    request.id,
                    false,
                    request.criado_em
                );
                pendingDiv.appendChild(friendDiv);
            });
        }
        
        // RENDERIZA AMIGOS
        const friendsDiv = document.getElementById('friends-list');
        if (!acceptedFriends || acceptedFriends.length === 0) {
            friendsDiv.innerHTML = '<div class="empty-message">Voc√™ ainda n√£o tem amigos. Adicione alguns!</div>';
        } else {
            friendsDiv.innerHTML = '';
            acceptedFriends.forEach(friend => {
                // Determina qual usu√°rio √© o amigo (n√£o o usu√°rio atual)
                const friendData = friend.user_id == user_id ? 
                    friend['users!friends_friend_id_fkey'] : 
                    friend['users!friends_user_id_fkey'];
                
                const friendDiv = createFriendItem(
                    friendData,
                    'aceito',
                    friend.id,
                    true,
                    friend.criado_em
                );
                friendsDiv.appendChild(friendDiv);
            });
        }
        
        // RENDERIZA SOLICITA√á√ïES ENVIADAS
        const sentDiv = document.getElementById('sent-requests');
        if (!sentRequests || sentRequests.length === 0) {
            sentDiv.innerHTML = '<div class="empty-message">Nenhuma solicita√ß√£o enviada</div>';
        } else {
            sentDiv.innerHTML = '';
            sentRequests.forEach(request => {
                const friendDiv = createFriendItem(
                    request.users,
                    'enviada',
                    request.id,
                    false,
                    request.criado_em
                );
                sentDiv.appendChild(friendDiv);
            });
        }
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao carregar amigos');
    }
}

// CRIAR ITEM DE AMIGO
function createFriendItem(userData, status, friendId, isAccepted, createdAt) {
    const div = document.createElement('div');
    div.className = 'friend-item';
    
    const userName = `${userData.nome || ''} ${userData.sobrenome || ''}`.trim() || 
                     userData.username || 'Usu√°rio';
    const firstLetter = userName.charAt(0).toUpperCase();
    const friendDate = createdAt ? new Date(createdAt).toLocaleDateString('pt-BR') : '';
    
    let actionsHtml = '';
    if (status === 'pendente') {
        actionsHtml = `
            <button class="btn-accept" onclick="acceptFriend(${friendId})">Aceitar</button>
            <button class="btn-reject" onclick="rejectFriend(${friendId})">Recusar</button>
        `;
    } else if (status === 'aceito') {
        actionsHtml = `<button class="btn-remove" onclick="removeFriend(${friendId})">Remover Amigo</button>`;
    } else if (status === 'enviada') {
        actionsHtml = `<button class="btn-cancel" onclick="cancelRequest(${friendId})">Cancelar Solicita√ß√£o</button>`;
    }
    
    const statusText = status === 'pendente' ? 'Solicita√ß√£o pendente' :
                      status === 'aceito' ? 'Amigo' :
                      status === 'enviada' ? 'Solicita√ß√£o enviada' : status;
    
    div.innerHTML = `
        <div class="friend-info">
            <div class="friend-avatar">${firstLetter}</div>
            <div class="friend-details">
                <div class="friend-name">${userName}</div>
                <div class="friend-username">@${userData.username || 'semusuario'}</div>
                <div class="friend-status status-${status}">${statusText} ‚Ä¢ ${friendDate}</div>
            </div>
        </div>
        <div class="friend-actions">
            ${actionsHtml}
        </div>
    `;
    
    return div;
}

// ACEITAR AMIGO
async function acceptFriend(id) {
    try {
        const { error } = await supabase
            .from('friends')
            .update({ status: 'aceito' })
            .eq('id', id);
        
        if (error) {
            alert('Erro ao aceitar solicita√ß√£o: ' + error.message);
            return;
        }
        
        alert('Solicita√ß√£o aceita! Agora voc√™s s√£o amigos.');
        loadFriends();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao aceitar solicita√ß√£o');
    }
}

// RECUSAR AMIGO
async function rejectFriend(id) {
    if (!confirm('Tem certeza que deseja recusar esta solicita√ß√£o de amizade?')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('friends')
            .delete()
            .eq('id', id);
        
        if (error) {
            alert('Erro ao recusar solicita√ß√£o: ' + error.message);
            return;
        }
        
        alert('Solicita√ß√£o recusada.');
        loadFriends();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao recusar solicita√ß√£o');
    }
}

// REMOVER AMIGO
async function removeFriend(id) {
    if (!confirm('Tem certeza que deseja remover este amigo?')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('friends')
            .delete()
            .eq('id', id);
        
        if (error) {
            alert('Erro ao remover amigo: ' + error.message);
            return;
        }
        
        alert('Amigo removido.');
        loadFriends();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao remover amigo');
    }
}

// CANCELAR SOLICITA√á√ÉO ENVIADA
async function cancelRequest(id) {
    if (!confirm('Tem certeza que deseja cancelar esta solicita√ß√£o?')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('friends')
            .delete()
            .eq('id', id);
        
        if (error) {
            alert('Erro ao cancelar solicita√ß√£o: ' + error.message);
            return;
        }
        
        alert('Solicita√ß√£o cancelada.');
        loadFriends();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao cancelar solicita√ß√£o');
    }
}

// INICIALIZAR
window.addEventListener('DOMContentLoaded', loadFriends);
</script>

</body>
</html>
