<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FakeBook - Grupo</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body { 
    font-family: Arial, sans-serif; 
    background: #f0f2f5; 
    color: #333;
    font-size: 16px;
}

header { 
    background: #1877f2; 
    color: white; 
    padding: 15px 20px; 
    font-size: 28px;
    text-align: center;
}

nav {
    background: white; 
    padding: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

nav a {
    margin: 0 12px;
    color: #1877f2;
    text-decoration: none;
    font-size: 17px;
    font-weight: 500;
    padding: 6px 10px;
    border-radius: 5px;
    transition: background 0.3s;
}

nav a:hover {
    background: #f0f2f5;
}

.container {
    max-width: 1100px;
    margin: 25px auto;
    display: flex;
    gap: 25px;
    padding: 0 20px;
}

.group-info {
    flex: 1;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.group-posts {
    flex: 2;
    background: white;
    padding: 20px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.post {
    background: #f8f9fa;
    padding: 18px;
    border-radius: 10px;
    margin-bottom: 18px;
    font-size: 16px;
}

.post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.post-author {
    font-weight: bold;
    color: #1877f2;
    font-size: 17px;
}

.post-time {
    color: #666;
    font-size: 14px;
}

.post-content {
    margin: 12px 0;
    line-height: 1.5;
    font-size: 16px;
}

.post-media {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 12px;
}

h3 {
    font-size: 24px;
    color: #1877f2;
    margin-bottom: 15px;
}

h4 {
    font-size: 18px;
    color: #333;
    margin: 20px 0 12px 0;
}

input, textarea {
    width: 100%;
    padding: 14px;
    margin: 10px 0 15px 0;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 16px;
}

button {
    padding: 14px 24px;
    border: none;
    border-radius: 8px;
    background: #1877f2;
    color: white;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: background 0.3s;
}

button:hover {
    background: #166fe5;
}

.member-list {
    list-style: none;
    padding: 0;
    margin: 15px 0;
}

.member-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
    font-size: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.member-name {
    font-weight: 500;
}

.member-role {
    font-size: 14px;
    color: #666;
    padding: 4px 10px;
    background: #f0f2f5;
    border-radius: 5px;
}

.group-stats {
    display: flex;
    gap: 20px;
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.stat-item {
    text-align: center;
    flex: 1;
}

.stat-value {
    font-size: 22px;
    font-weight: bold;
    color: #1877f2;
}

.stat-label {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.group-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}

.btn-secondary {
    background: #42b72a;
}

.btn-secondary:hover {
    background: #36a420;
}

.btn-danger {
    background: #f02849;
}

.btn-danger:hover {
    background: #e02445;
}

#posts-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    max-height: 500px;
}

#post-form {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.group-privacy-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    margin-left: 10px;
    background: #e7f3ff;
    color: #1877f2;
}

@media (max-width: 768px) {
    .container {
        flex-direction: column;
    }
    
    nav a {
        display: inline-block;
        margin: 5px;
    }
}
</style>
</head>
<body>

<header>FakeBook</header>
<nav>
  <a href="feed.html">Feed</a>
  <a href="profile.html">Perfil</a>
  <a href="friends.html">Amigos</a>
  <a href="groups.html">Grupos</a>
  <a href="pages.html">P√°ginas</a>
  <a href="media.html">M√≠dia</a>
  <a href="stories.html">Stories</a>
  <a href="settings.html">Configura√ß√µes</a>
  <a href="login.html">Logout</a>
</nav>

<div class="container">
    <!-- INFORMA√á√ïES DO GRUPO -->
    <div class="group-info">
        <h3 id="group-name">Carregando grupo...</h3>
        <div class="group-stats">
            <div class="stat-item">
                <div class="stat-value" id="member-count">0</div>
                <div class="stat-label">Membros</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="post-count">0</div>
                <div class="stat-label">Posts</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="admin-count">0</div>
                <div class="stat-label">Admins</div>
            </div>
        </div>
        
        <p id="group-desc" style="margin: 15px 0; font-size: 16px; color: #555;"></p>
        <p style="font-size: 16px;">
            <strong>Privacidade:</strong> 
            <span id="group-privacy" class="group-privacy-badge"></span>
        </p>
        
        <div id="user-status" style="margin: 15px 0; padding: 12px; background: #e7f3ff; border-radius: 8px; font-size: 16px;">
            Verificando seu status...
        </div>
        
        <div class="group-actions" id="group-actions" style="display: none;">
            <button id="join-btn" class="btn-secondary">Entrar no Grupo</button>
            <button id="leave-btn" class="btn-danger">Sair do Grupo</button>
        </div>
        
        <h4>Membros do Grupo</h4>
        <ul class="member-list" id="group-members">
            <li>Carregando membros...</li>
        </ul>
    </div>

    <!-- POSTS DO GRUPO -->
    <div class="group-posts">
        <h3>Posts do Grupo</h3>
        
        <div id="posts-container">
            <div id="posts">Carregando posts...</div>
        </div>
        
        <div id="post-form" style="display: none;">
            <textarea id="post-content" placeholder="Escreva algo no grupo..." rows="4"></textarea>
            <input type="text" id="post-media" placeholder="URL de m√≠dia (opcional)">
            <button onclick="createPost()">Postar no Grupo</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://umzlriwvexvaabliriva.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtemxyaXd2ZXh2YWFibGlyaXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NjEwMjQsImV4cCI6MjA4MDQzNzAyNH0.8miF7Z0e2sTduJhveCk-6GKzroS0CYF-PS6BZeEKpEI";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const user_id = localStorage.getItem('user_id');
if(!user_id) { 
    alert('Fa√ßa login primeiro!');
    window.location.href = 'login.html'; 
}

const urlParams = new URLSearchParams(window.location.search);
const group_id = urlParams.get('id');
if(!group_id) { 
    alert('Grupo n√£o especificado!');
    window.location.href = 'groups.html'; 
}

let currentGroup = null;
let isMember = false;
let userRole = '';

// CARREGAR INFORMA√á√ïES DO GRUPO
async function loadGroup() {
    try {
        const { data, error } = await supabase
            .from('groups')
            .select('*')
            .eq('id', group_id)
            .single();
        
        if (error || !data) {
            alert('Grupo n√£o encontrado!');
            window.location.href = 'groups.html';
            return;
        }
        
        currentGroup = data;
        
        document.getElementById('group-name').innerText = data.nome;
        document.getElementById('group-desc').innerText = data.descricao || 'Sem descri√ß√£o';
        
        let privacyText = '';
        let privacyBadge = '';
        switch(data.privacidade) {
            case 'publico':
                privacyText = 'üåç P√∫blico';
                privacyBadge = 'P√∫blico';
                break;
            case 'fechado':
                privacyText = 'üîí Fechado';
                privacyBadge = 'Fechado';
                break;
            case 'secreto':
                privacyText = 'üïµÔ∏è Secreto';
                privacyBadge = 'Secreto';
                break;
            default:
                privacyText = data.privacidade;
                privacyBadge = data.privacidade;
        }
        
        document.getElementById('group-privacy').innerText = privacyBadge;
        document.title = `FakeBook - ${data.nome}`;
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao carregar informa√ß√µes do grupo');
    }
}

// VERIFICAR STATUS DO USU√ÅRIO
async function checkUserStatus() {
    try {
        // VERIFICA SE √â MEMBRO
        const { data: membership } = await supabase
            .from('group_members')
            .select('id, cargo')
            .eq('group_id', group_id)
            .eq('user_id', user_id)
            .single();
        
        isMember = !!membership;
        userRole = membership ? membership.cargo : '';
        
        const statusDiv = document.getElementById('user-status');
        const actionsDiv = document.getElementById('group-actions');
        const postForm = document.getElementById('post-form');
        const joinBtn = document.getElementById('join-btn');
        const leaveBtn = document.getElementById('leave-btn');
        
        if (isMember) {
            statusDiv.innerHTML = `<strong>Voc√™ √© ${userRole} deste grupo</strong>`;
            statusDiv.style.background = '#e7f3ff';
            postForm.style.display = 'block';
            actionsDiv.style.display = 'flex';
            joinBtn.style.display = 'none';
            leaveBtn.style.display = 'block';
        } else {
            if (currentGroup.privacidade === 'publico') {
                statusDiv.innerHTML = '<strong>Grupo p√∫blico</strong> - Voc√™ pode ver os posts';
                statusDiv.style.background = '#f0f2f5';
                postForm.style.display = 'none';
                actionsDiv.style.display = 'flex';
                joinBtn.style.display = 'block';
                joinBtn.innerText = 'Entrar no Grupo';
                leaveBtn.style.display = 'none';
            } else if (currentGroup.privacidade === 'fechado') {
                statusDiv.innerHTML = '<strong>Grupo fechado</strong> - Solicite entrada para participar';
                statusDiv.style.background = '#fff3cd';
                postForm.style.display = 'none';
                actionsDiv.style.display = 'flex';
                joinBtn.style.display = 'block';
                joinBtn.innerText = 'Solicitar Entrada';
                leaveBtn.style.display = 'none';
            } else {
                statusDiv.innerHTML = '<strong>Grupo secreto</strong> - Acesso apenas para membros';
                statusDiv.style.background = '#f8d7da';
                postForm.style.display = 'none';
                actionsDiv.style.display = 'none';
            }
        }
        
        // CONFIGURA BOT√ïES
        joinBtn.onclick = joinGroup;
        leaveBtn.onclick = leaveGroup;
        
    } catch (err) {
        console.error('Erro:', err);
    }
}

// CARREGAR MEMBROS
async function loadMembers() {
    try {
        const { data, error } = await supabase
            .from('group_members')
            .select(`
                id,
                cargo,
                criado_em,
                user_id,
                users!inner(nome, sobrenome, username)
            `)
            .eq('group_id', group_id)
            .order('criado_em', { ascending: true });
        
        if (error) {
            console.error('Erro membros:', error);
            document.getElementById('group-members').innerHTML = '<li>Erro ao carregar membros</li>';
            return;
        }
        
        const membersList = document.getElementById('group-members');
        const memberCount = document.getElementById('member-count');
        const adminCount = document.getElementById('admin-count');
        
        membersList.innerHTML = '';
        
        if (!data || data.length === 0) {
            membersList.innerHTML = '<li>Nenhum membro</li>';
            memberCount.innerText = '0';
            adminCount.innerText = '0';
            return;
        }
        
        let adminCountValue = 0;
        
        data.forEach(member => {
            const li = document.createElement('li');
            li.className = 'member-item';
            
            const userName = member.users ? 
                `${member.users.nome || ''} ${member.users.sobrenome || ''}`.trim() || 
                member.users.username || 'Usu√°rio' : 
                'Usu√°rio';
            
            li.innerHTML = `
                <div class="member-name">${userName}</div>
                <div class="member-role">${member.cargo || 'membro'}</div>
            `;
            
            membersList.appendChild(li);
            
            if (member.cargo === 'admin') {
                adminCountValue++;
            }
        });
        
        memberCount.innerText = data.length;
        adminCount.innerText = adminCountValue;
        
    } catch (err) {
        console.error('Erro:', err);
    }
}

// CARREGAR POSTS
async function loadPosts() {
    try {
        const container = document.getElementById('posts');
        container.innerHTML = '<p>Carregando posts...</p>';
        
        // SE N√ÉO √â MEMBRO E GRUPO N√ÉO √â P√öBLICO
        if (!isMember && currentGroup.privacidade !== 'publico') {
            container.innerHTML = '<p>Voc√™ precisa ser membro para ver os posts deste grupo</p>';
            document.getElementById('post-count').innerText = '0';
            return;
        }
        
        const { data, error } = await supabase
            .from('group_posts')
            .select(`
                id,
                conteudo,
                midia_url,
                criado_em,
                user_id,
                users!inner(nome, sobrenome, username)
            `)
            .eq('group_id', group_id)
            .order('criado_em', { ascending: false });
        
        if (error) {
            console.error('Erro posts:', error);
            container.innerHTML = '<p>Erro ao carregar posts</p>';
            return;
        }
        
        container.innerHTML = '';
        
        if (!data || data.length === 0) {
            container.innerHTML = '<p>Nenhum post neste grupo ainda</p>';
            document.getElementById('post-count').innerText = '0';
            return;
        }
        
        document.getElementById('post-count').innerText = data.length;
        
        data.forEach(post => {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            
            const userName = post.users ? 
                `${post.users.nome || ''} ${post.users.sobrenome || ''}`.trim() || 
                post.users.username || 'Usu√°rio' : 
                'Usu√°rio';
            
            const postDate = post.criado_em ? 
                new Date(post.criado_em).toLocaleString('pt-BR') : '';
            
            let mediaHtml = '';
            if (post.midia_url) {
                mediaHtml = `<img src="${post.midia_url}" class="post-media">`;
            }
            
            postDiv.innerHTML = `
                <div class="post-header">
                    <div class="post-author">${userName}</div>
                    <div class="post-time">${postDate}</div>
                </div>
                <div class="post-content">${post.conteudo || ''}</div>
                ${mediaHtml}
            `;
            
            container.appendChild(postDiv);
        });
        
    } catch (err) {
        console.error('Erro:', err);
        document.getElementById('posts').innerHTML = '<p>Erro ao carregar posts</p>';
    }
}

// ENTRAR NO GRUPO
async function joinGroup() {
    try {
        const cargo = currentGroup.privacidade === 'fechado' ? 'solicitante' : 'membro';
        
        const { error } = await supabase
            .from('group_members')
            .insert([{
                group_id: group_id,
                user_id: user_id,
                cargo: cargo
            }]);
        
        if (error) {
            alert('Erro ao entrar no grupo: ' + error.message);
            return;
        }
        
        alert(currentGroup.privacidade === 'fechado' ? 
            'Solicita√ß√£o de entrada enviada!' : 
            'Voc√™ entrou no grupo!');
        
        // RECARREGA DADOS
        await checkUserStatus();
        await loadMembers();
        await loadPosts();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao entrar no grupo');
    }
}

// SAIR DO GRUPO
async function leaveGroup() {
    if (!confirm('Tem certeza que deseja sair deste grupo?')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('group_members')
            .delete()
            .eq('group_id', group_id)
            .eq('user_id', user_id);
        
        if (error) {
            alert('Erro ao sair do grupo: ' + error.message);
            return;
        }
        
        alert('Voc√™ saiu do grupo');
        
        // RECARREGA DADOS
        await checkUserStatus();
        await loadMembers();
        await loadPosts();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao sair do grupo');
    }
}

// CRIAR POST
async function createPost() {
    if (!isMember) {
        alert('Voc√™ precisa ser membro para postar');
        return;
    }
    
    const conteudo = document.getElementById('post-content').value.trim();
    const midia_url = document.getElementById('post-media').value.trim();
    
    if (!conteudo && !midia_url) {
        alert('Digite algo ou insira m√≠dia');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('group_posts')
            .insert([{
                group_id: group_id,
                user_id: user_id,
                conteudo: conteudo,
                midia_url: midia_url || null
            }]);
        
        if (error) {
            alert('Erro ao criar post: ' + error.message);
            return;
        }
        
        alert('Post criado com sucesso!');
        
        document.getElementById('post-content').value = '';
        document.getElementById('post-media').value = '';
        
        await loadPosts();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao criar post');
    }
}

// INICIALIZAR
async function initialize() {
    await loadGroup();
    await checkUserStatus();
    await loadMembers();
    await loadPosts();
}

window.addEventListener('DOMContentLoaded', initialize);
</script>

</body>
</html>
