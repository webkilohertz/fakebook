<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FakeBook - Grupos</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body { 
    font-family: Arial, sans-serif; 
    background: #f0f2f5; 
    color: #333;
    font-size: 16px;
}

header { 
    background: #1877f2; 
    color: white; 
    padding: 15px 20px; 
    font-size: 28px;
    text-align: center;
}

nav {
    background: white; 
    padding: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

nav a {
    margin: 0 12px;
    color: #1877f2;
    text-decoration: none;
    font-size: 17px;
    font-weight: 500;
    padding: 6px 10px;
    border-radius: 5px;
    transition: background 0.3s;
}

nav a:hover {
    background: #f0f2f5;
}

.container {
    max-width: 1000px;
    margin: 25px auto;
    display: flex;
    gap: 25px;
    padding: 0 20px;
}

.group-list {
    flex: 1;
    background: white;
    padding: 20px;
    border-radius: 12px;
    max-height: 600px;
    overflow-y: auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.group-details {
    flex: 2;
    background: white;
    padding: 20px;
    border-radius: 12px;
    max-height: 600px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.group {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    font-size: 17px;
    transition: background 0.3s;
}

.group:hover {
    background: #f8f9fa;
}

.post {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 16px;
}

.post strong {
    color: #1877f2;
    font-size: 17px;
}

h3 {
    font-size: 22px;
    color: #1877f2;
    margin-bottom: 20px;
}

h4 {
    font-size: 18px;
    color: #333;
    margin: 20px 0 10px 0;
}

input, textarea, select {
    width: 100%;
    padding: 12px;
    margin: 8px 0 15px 0;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 16px;
}

button {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    background: #1877f2;
    color: white;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: background 0.3s;
}

button:hover {
    background: #166fe5;
}

.group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.btn-small {
    padding: 8px 15px;
    font-size: 14px;
    background: #42b72a;
}

.btn-small:hover {
    background: #36a420;
}

.member-status {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

#posts-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

@media (max-width: 768px) {
    .container {
        flex-direction: column;
    }
    
    nav a {
        display: inline-block;
        margin: 5px;
    }
}
</style>
</head>
<body>

<header>FakeBook</header>
<nav>
  <a href="feed.html">Feed</a>
  <a href="profile.html">Perfil</a>
  <a href="friends.html">Amigos</a>
  <a href="groups.html">Grupos</a>
  <a href="pages.html">P√°ginas</a>
  <a href="media.html">M√≠dia</a>
  <a href="stories.html">Stories</a>
  <a href="settings.html">Configura√ß√µes</a>
  <a href="login.html">Logout</a>
</nav>

<div class="container">
    <!-- LISTA DE GRUPOS -->
    <div class="group-list">
        <h3>Grupos</h3>
        <div id="groups-list"></div>
        
        <h4>Criar Novo Grupo</h4>
        <input type="text" id="group-name" placeholder="Nome do grupo">
        <input type="text" id="group-desc" placeholder="Descri√ß√£o">
        <select id="group-privacy">
            <option value="publico">P√∫blico</option>
            <option value="fechado">Fechado</option>
            <option value="secreto">Secreto</option>
        </select>
        <button onclick="createGroup()">Criar Grupo</button>
    </div>

    <!-- DETALHES DO GRUPO -->
    <div class="group-details">
        <div class="group-header">
            <h3 id="selected-group-name">Selecione um grupo</h3>
            <button id="join-btn" class="btn-small" onclick="joinGroup()" style="display:none;">Entrar no Grupo</button>
        </div>
        
        <div class="member-status" id="member-status"></div>
        
        <div id="posts-container">
            <div id="group-posts"></div>
        </div>
        
        <div id="post-form" style="display:none;">
            <textarea id="post-content" placeholder="Escreva algo no grupo..." rows="3"></textarea>
            <input type="text" id="post-media" placeholder="URL de m√≠dia (opcional)">
            <button onclick="createGroupPost()">Postar</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://umzlriwvexvaabliriva.supabase.co";
//const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSEuIiwicmVmIjoiInV0emxyaXd2ZXh2YW.FibGlyaXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NjEwMjQsImV4cCI6MjA4MDQzNzAyNH0.8miF7Z0e2sTduJhveCk-6GKzroS0CYF-PS6BZeEKpEI";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtemxyaXd2ZXh2YWFibGlyaXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NjEwMjQsImV4cCI6MjA4MDQzNzAyNH0.8miF7Z0e2sTduJhveCk-6GKzroS0CYF-PS6BZeEKpEI";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const user_id = localStorage.getItem('user_id');
if(!user_id) { 
    alert('Fa√ßa login primeiro!');
    window.location.href = 'login.html'; 
}

let selectedGroup = null;
let isMember = false;
let groupPrivacy = '';

// CARREGAR GRUPOS
async function loadGroups() {
    const list = document.getElementById('groups-list');
    list.innerHTML = '<p>Carregando grupos...</p>';
    
    try {
        const { data, error } = await supabase
            .from('groups')
            .select('*')
            .order('criado_em', { ascending: false });
        
        if (error) {
            console.error('Erro grupos:', error);
            list.innerHTML = '<p>Erro ao carregar grupos</p>';
            return;
        }
        
        if (!data || data.length === 0) {
            list.innerHTML = '<p>Nenhum grupo encontrado</p>';
            return;
        }
        
        list.innerHTML = '';
        
        data.forEach(group => {
            const div = document.createElement('div');
            div.className = 'group';
            div.innerHTML = `
                <div style="font-weight:bold;">${group.nome}</div>
                <div style="font-size:14px; color:#666; margin-top:5px;">${group.privacidade === 'publico' ? 'üåç P√∫blico' : group.privacidade === 'fechado' ? 'üîí Fechado' : 'üïµÔ∏è Secreto'}</div>
                <div style="font-size:14px; color:#888; margin-top:3px;">${group.descricao || 'Sem descri√ß√£o'}</div>
            `;
            
            div.onclick = () => {
                selectGroup(group.id, group.nome, group.privacidade);
            };
            
            list.appendChild(div);
        });
        
    } catch (err) {
        console.error('Erro:', err);
        list.innerHTML = '<p>Erro ao carregar grupos</p>';
    }
}

// SELECIONAR GRUPO
async function selectGroup(id, name, privacy) {
    selectedGroup = id;
    groupPrivacy = privacy;
    
    document.getElementById('selected-group-name').innerText = name;
    document.getElementById('member-status').innerText = '';
    document.getElementById('post-form').style.display = 'none';
    document.getElementById('join-btn').style.display = 'none';
    
    // VERIFICA SE √â MEMBRO
    const { data: membership } = await supabase
        .from('group_members')
        .select('id, cargo')
        .eq('group_id', id)
        .eq('user_id', user_id)
        .single();
    
    isMember = !!membership;
    
    if (isMember) {
        document.getElementById('member-status').innerText = `Voc√™ √© ${membership.cargo} deste grupo`;
        document.getElementById('post-form').style.display = 'block';
    } else {
        if (privacy === 'publico') {
            document.getElementById('member-status').innerText = 'Grupo p√∫blico - Voc√™ pode ver posts';
            document.getElementById('join-btn').style.display = 'block';
            document.getElementById('join-btn').innerText = 'Entrar no Grupo';
        } else if (privacy === 'fechado') {
            document.getElementById('member-status').innerText = 'Grupo fechado - Solicite entrada';
            document.getElementById('join-btn').style.display = 'block';
            document.getElementById('join-btn').innerText = 'Solicitar Entrada';
        } else {
            document.getElementById('member-status').innerText = 'Grupo secreto - Acesso apenas para membros';
        }
    }
    
    loadGroupPosts();
}

// ENTRAR NO GRUPO
async function joinGroup() {
    if (!selectedGroup) return;
    
    try {
        const { error } = await supabase
            .from('group_members')
            .insert([{
                group_id: selectedGroup,
                user_id: user_id,
                cargo: groupPrivacy === 'fechado' ? 'solicitante' : 'membro'
            }]);
        
        if (error) {
            alert('Erro ao entrar no grupo: ' + error.message);
            return;
        }
        
        alert(groupPrivacy === 'fechado' ? 'Solicita√ß√£o enviada!' : 'Voc√™ entrou no grupo!');
        selectGroup(selectedGroup, document.getElementById('selected-group-name').innerText, groupPrivacy);
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao entrar no grupo');
    }
}

// CRIAR GRUPO
async function createGroup() {
    const nome = document.getElementById('group-name').value.trim();
    const descricao = document.getElementById('group-desc').value.trim();
    const privacidade = document.getElementById('group-privacy').value;
    
    if (!nome) {
        alert('Digite o nome do grupo');
        return;
    }
    
    try {
        // CRIA O GRUPO
        const { data: newGroup, error: groupError } = await supabase
            .from('groups')
            .insert([{ nome, descricao, privacidade }])
            .select()
            .single();
        
        if (groupError) {
            alert('Erro ao criar grupo: ' + groupError.message);
            return;
        }
        
        // ADICIONA CRIADOR COMO ADMIN
        await supabase
            .from('group_members')
            .insert([{
                group_id: newGroup.id,
                user_id: user_id,
                cargo: 'admin'
            }]);
        
        alert('Grupo criado com sucesso!');
        
        document.getElementById('group-name').value = '';
        document.getElementById('group-desc').value = '';
        
        loadGroups();
        selectGroup(newGroup.id, newGroup.nome, newGroup.privacidade);
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao criar grupo');
    }
}

// CARREGAR POSTS DO GRUPO
async function loadGroupPosts() {
    if (!selectedGroup) return;
    
    const container = document.getElementById('group-posts');
    container.innerHTML = '<p>Carregando posts...</p>';
    
    try {
        // SE N√ÉO √â MEMBRO E GRUPO N√ÉO √â P√öBLICO
        if (!isMember && groupPrivacy !== 'publico') {
            container.innerHTML = '<p>Voc√™ precisa ser membro para ver os posts deste grupo</p>';
            return;
        }
        
        // CARREGA POSTS COM INFORMA√á√ïES DO USU√ÅRIO
        const { data, error } = await supabase
            .from('group_posts')
            .select(`
                id,
                conteudo,
                midia_url,
                criado_em,
                user_id,
                users!inner(nome, sobrenome, username)
            `)
            .eq('group_id', selectedGroup)
            .order('criado_em', { ascending: false })
            .limit(20);
        
        if (error) {
            console.error('Erro posts:', error);
            container.innerHTML = '<p>Erro ao carregar posts</p>';
            return;
        }
        
        if (!data || data.length === 0) {
            container.innerHTML = '<p>Nenhum post neste grupo</p>';
            return;
        }
        
        container.innerHTML = '';
        
        data.forEach(post => {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            
            const userName = post.users ? 
                `${post.users.nome || ''} ${post.users.sobrenome || ''}`.trim() || 
                post.users.username || 'Usu√°rio' : 
                'Usu√°rio';
            
            const postDate = post.criado_em ? 
                new Date(post.criado_em).toLocaleString('pt-BR') : '';
            
            let mediaHtml = '';
            if (post.midia_url) {
                mediaHtml = `<img src="${post.midia_url}" style="max-width:100%; border-radius:8px; margin-top:10px;">`;
            }
            
            postDiv.innerHTML = `
                <div>
                    <strong>${userName}</strong>
                    <small style="color:#666; margin-left:10px;">${postDate}</small>
                </div>
                <div style="margin:10px 0;">${post.conteudo || ''}</div>
                ${mediaHtml}
            `;
            
            container.appendChild(postDiv);
        });
        
    } catch (err) {
        console.error('Erro:', err);
        container.innerHTML = '<p>Erro ao carregar posts</p>';
    }
}

// CRIAR POST NO GRUPO
async function createGroupPost() {
    if (!selectedGroup || !isMember) {
        alert('Voc√™ precisa ser membro para postar');
        return;
    }
    
    const conteudo = document.getElementById('post-content').value.trim();
    const midia_url = document.getElementById('post-media').value.trim();
    
    if (!conteudo && !midia_url) {
        alert('Digite algo ou insira m√≠dia');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('group_posts')
            .insert([{
                group_id: selectedGroup,
                user_id: user_id,
                conteudo: conteudo,
                midia_url: midia_url || null
            }]);
        
        if (error) {
            alert('Erro ao criar post: ' + error.message);
            return;
        }
        
        alert('Post criado com sucesso!');
        
        document.getElementById('post-content').value = '';
        document.getElementById('post-media').value = '';
        
        loadGroupPosts();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao criar post');
    }
}

// INICIALIZAR
window.addEventListener('DOMContentLoaded', loadGroups);
</script>

</body>
</html>
