<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FakeBook - Notifica√ß√µes</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body { 
    font-family: Arial, sans-serif; 
    background: #f0f2f5; 
    color: #333;
    font-size: 18px;
}

header { 
    background: #1877f2; 
    color: white; 
    padding: 20px; 
    font-size: 28px;
    text-align: center;
}

nav {
    background: white; 
    padding: 15px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

nav a {
    margin: 0 15px;
    color: #1877f2;
    text-decoration: none;
    font-size: 18px;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background 0.3s;
}

nav a:hover {
    background: #f0f2f5;
}

.container {
    max-width: 800px;
    margin: 30px auto;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

h2 {
    font-size: 24px;
    color: #1877f2;
    margin-bottom: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
}

.stat-item {
    text-align: center;
    flex: 1;
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    color: #1877f2;
}

.stat-label {
    font-size: 14px;
    color: #65676b;
    margin-top: 5px;
}

.notification-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.notification-item {
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #e4e6eb;
    display: flex;
    align-items: flex-start;
    gap: 15px;
    transition: all 0.3s;
}

.notification-item.unread {
    background: #e7f3ff;
    border-color: #1877f2;
    border-left: 4px solid #1877f2;
}

.notification-item.read {
    background: #f8f9fa;
    opacity: 0.8;
}

.notification-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}

.icon-friend {
    background: #42b72a;
    color: white;
}

.icon-like {
    background: #f02849;
    color: white;
}

.icon-comment {
    background: #1877f2;
    color: white;
}

.icon-group {
    background: #f7b928;
    color: white;
}

.icon-follow {
    background: #8a3ab9;
    color: white;
}

.icon-system {
    background: #6c757d;
    color: white;
}

.notification-content {
    flex: 1;
}

.notification-message {
    font-size: 16px;
    line-height: 1.5;
    margin-bottom: 8px;
}

.notification-message strong {
    color: #1877f2;
}

.notification-time {
    font-size: 14px;
    color: #65676b;
}

.notification-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

button {
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-mark-read {
    background: #1877f2;
    color: white;
}

.btn-mark-read:hover {
    background: #166fe5;
}

.btn-delete {
    background: #f02849;
    color: white;
}

.btn-delete:hover {
    background: #e02445;
}

.btn-view {
    background: #42b72a;
    color: white;
}

.btn-view:hover {
    background: #36a420;
}

.btn-mark-all {
    background: #1877f2;
    color: white;
    padding: 12px 25px;
    font-size: 16px;
    margin-top: 20px;
}

.btn-mark-all:hover {
    background: #166fe5;
}

.btn-clear-all {
    background: #f02849;
    color: white;
    padding: 12px 25px;
    font-size: 16px;
    margin-top: 20px;
    margin-left: 15px;
}

.btn-clear-all:hover {
    background: #e02445;
}

.empty-notifications {
    text-align: center;
    padding: 50px;
    color: #666;
    font-size: 18px;
}

.notification-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.filter-btn {
    padding: 8px 16px;
    background: #f0f2f5;
    color: #65676b;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
}

.filter-btn.active {
    background: #1877f2;
    color: white;
}

.filter-btn:hover {
    background: #e4e6eb;
}

.filter-btn.active:hover {
    background: #166fe5;
}

.notification-options {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .container {
        padding: 20px;
        margin: 15px;
    }
    
    .notification-options {
        flex-direction: column;
        gap: 15px;
    }
}
</style>
</head>
<body>

<header>FakeBook - Notifica√ß√µes</header>
<nav>
    <a href="feed.html">Feed</a>
    <a href="profile.html">Perfil</a>
    <a href="friends.html">Amigos</a>
    <a href="messages.html">Mensagens</a>
    <a href="notifications.html">Notifica√ß√µes</a>
    <a href="login.html">Logout</a>
</nav>

<div class="container">
    <!-- ESTAT√çSTICAS -->
    <div class="notification-stats">
        <div class="stat-item">
            <div class="stat-value" id="total-count">0</div>
            <div class="stat-label">Total</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="unread-count">0</div>
            <div class="stat-label">N√£o Lidas</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="today-count">0</div>
            <div class="stat-label">Hoje</div>
        </div>
    </div>
    
    <!-- FILTROS -->
    <div class="notification-filters">
        <button class="filter-btn active" onclick="filterNotifications('all')">Todas</button>
        <button class="filter-btn" onclick="filterNotifications('unread')">N√£o Lidas</button>
        <button class="filter-btn" onclick="filterNotifications('friends')">Amigos</button>
        <button class="filter-btn" onclick="filterNotifications('likes')">Curtidas</button>
        <button class="filter-btn" onclick="filterNotifications('comments')">Coment√°rios</button>
    </div>
    
    <!-- OP√á√ïES -->
    <div class="notification-options">
        <h2>üì¨ Suas Notifica√ß√µes</h2>
        <div>
            <button class="btn-mark-all" onclick="markAllAsRead()">Marcar Todas como Lidas</button>
            <button class="btn-clear-all" onclick="clearAllNotifications()">Limpar Todas</button>
        </div>
    </div>
    
    <!-- LISTA DE NOTIFICA√á√ïES -->
    <div id="notifications-list" class="notification-list">
        <div class="empty-notifications">Carregando notifica√ß√µes...</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://umzlriwvexvaabliriva.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtemxyaXd2ZXh2YWFibGlyaXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NjEwMjQsImV4cCI6MjA4MDQzNzAyNH0.8miF7Z0e2sTduJhveCk-6GKzroS0CYF-PS6BZeEKpEI";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const user_id = localStorage.getItem('user_id');
if(!user_id) { 
    alert('Fa√ßa login primeiro!');
    window.location.href = 'login.html'; 
}

let currentFilter = 'all';

// CARREGAR NOTIFICA√á√ïES
async function loadNotifications() {
    try {
        // BUSCA TODAS AS NOTIFICA√á√ïES DO USU√ÅRIO
        const { data: notifications, error } = await supabase
            .from('notifications')
            .select('*')
            .eq('user_id', user_id)
            .order('criado_em', { ascending: false })
            .limit(50);
        
        if (error) {
            console.error('Erro notifica√ß√µes:', error);
            showError('Erro ao carregar notifica√ß√µes');
            return;
        }
        
        updateStats(notifications);
        renderNotifications(notifications);
        
    } catch (err) {
        console.error('Erro:', err);
        showError('Erro ao carregar notifica√ß√µes');
    }
}

// ATUALIZAR ESTAT√çSTICAS
function updateStats(notifications) {
    if (!notifications) return;
    
    const total = notifications.length;
    const unread = notifications.filter(n => !n.lido).length;
    
    // Conta notifica√ß√µes de hoje
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayCount = notifications.filter(n => {
        const notifDate = new Date(n.criado_em);
        return notifDate >= today;
    }).length;
    
    document.getElementById('total-count').textContent = total;
    document.getElementById('unread-count').textContent = unread;
    document.getElementById('today-count').textContent = todayCount;
}

// RENDERIZAR NOTIFICA√á√ïES
function renderNotifications(notifications) {
    const container = document.getElementById('notifications-list');
    
    if (!notifications || notifications.length === 0) {
        container.innerHTML = '<div class="empty-notifications">Nenhuma notifica√ß√£o encontrada</div>';
        return;
    }
    
    // APLICA FILTRO
    let filteredNotifications = notifications;
    if (currentFilter === 'unread') {
        filteredNotifications = notifications.filter(n => !n.lido);
    } else if (currentFilter === 'friends') {
        filteredNotifications = notifications.filter(n => 
            n.tipo === 'friend_request' || n.tipo === 'friend_accepted' || n.tipo === 'friend_request_sent'
        );
    } else if (currentFilter === 'likes') {
        filteredNotifications = notifications.filter(n => n.tipo === 'post_like' || n.tipo === 'comment_like');
    } else if (currentFilter === 'comments') {
        filteredNotifications = notifications.filter(n => n.tipo === 'post_comment' || n.tipo === 'comment_reply');
    }
    
    if (filteredNotifications.length === 0) {
        container.innerHTML = `<div class="empty-notifications">Nenhuma notifica√ß√£o "${getFilterName(currentFilter)}"</div>`;
        return;
    }
    
    container.innerHTML = '';
    
    filteredNotifications.forEach(notification => {
        const notificationDiv = document.createElement('div');
        notificationDiv.className = `notification-item ${notification.lido ? 'read' : 'unread'}`;
        
        // √çCONE BASEADO NO TIPO
        const iconClass = getIconClass(notification.tipo);
        const iconChar = getIconChar(notification.tipo);
        
        // TEMPO RELATIVO
        const timeAgo = getTimeAgo(notification.criado_em);
        
        // MENSAGEM FORMATADA
        const message = formatMessage(notification);
        
        notificationDiv.innerHTML = `
            <div class="notification-icon ${iconClass}">${iconChar}</div>
            <div class="notification-content">
                <div class="notification-message">${message}</div>
                <div class="notification-time">${timeAgo}</div>
                <div class="notification-actions">
                    ${!notification.lido ? `<button class="btn-mark-read" onclick="markAsRead(${notification.id})">Marcar como lida</button>` : ''}
                    <button class="btn-delete" onclick="deleteNotification(${notification.id})">Excluir</button>
                    ${notification.referencia_id ? `<button class="btn-view" onclick="viewNotification(${notification.id}, '${notification.tipo}', ${notification.referencia_id})">Ver</button>` : ''}
                </div>
            </div>
        `;
        
        container.appendChild(notificationDiv);
    });
}

// OBTER CLASSE DO √çCONE
function getIconClass(tipo) {
    switch(tipo) {
        case 'friend_request':
        case 'friend_accepted':
        case 'friend_request_sent':
            return 'icon-friend';
        case 'post_like':
        case 'comment_like':
            return 'icon-like';
        case 'post_comment':
        case 'comment_reply':
            return 'icon-comment';
        case 'group_invite':
        case 'group_post':
            return 'icon-group';
        case 'new_follower':
            return 'icon-follow';
        default:
            return 'icon-system';
    }
}

// OBTER CARACTERE DO √çCONE
function getIconChar(tipo) {
    switch(tipo) {
        case 'friend_request':
        case 'friend_accepted':
        case 'friend_request_sent':
            return 'üë•';
        case 'post_like':
        case 'comment_like':
            return 'üëç';
        case 'post_comment':
        case 'comment_reply':
            return 'üí¨';
        case 'group_invite':
        case 'group_post':
            return 'üë•';
        case 'new_follower':
            return 'üë£';
        default:
            return 'üîî';
    }
}

// FORMATAR MENSAGEM
function formatMessage(notification) {
    let message = notification.mensagem || '';
    
    // Se n√£o tiver mensagem, cria uma baseada no tipo
    if (!message) {
        switch(notification.tipo) {
            case 'friend_request':
                message = '<strong>Nova solicita√ß√£o de amizade</strong>';
                break;
            case 'friend_accepted':
                message = '<strong>Solicita√ß√£o de amizade aceita</strong>';
                break;
            case 'post_like':
                message = '<strong>Algu√©m curtiu seu post</strong>';
                break;
            case 'post_comment':
                message = '<strong>Novo coment√°rio no seu post</strong>';
                break;
            case 'new_follower':
                message = '<strong>Novo seguidor</strong>';
                break;
            case 'group_invite':
                message = '<strong>Convite para grupo</strong>';
                break;
            default:
                message = '<strong>Nova notifica√ß√£o</strong>';
        }
    }
    
    return message;
}

// OBTER TEMPO RELATIVO
function getTimeAgo(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffSec < 60) return 'Agora mesmo';
    if (diffMin < 60) return `H√° ${diffMin} minuto${diffMin !== 1 ? 's' : ''}`;
    if (diffHour < 24) return `H√° ${diffHour} hora${diffHour !== 1 ? 's' : ''}`;
    if (diffDay < 7) return `H√° ${diffDay} dia${diffDay !== 1 ? 's' : ''}`;
    
    return date.toLocaleDateString('pt-BR');
}

// FILTRAR NOTIFICA√á√ïES
function filterNotifications(filter) {
    currentFilter = filter;
    
    // Atualiza bot√µes de filtro
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Recarrega notifica√ß√µes (j√° aplica filtro no render)
    loadNotifications();
}

function getFilterName(filter) {
    const names = {
        'all': 'todas',
        'unread': 'n√£o lidas',
        'friends': 'de amigos',
        'likes': 'de curtidas',
        'comments': 'de coment√°rios'
    };
    return names[filter] || filter;
}

// MARCAR COMO LIDA
async function markAsRead(id) {
    try {
        const { error } = await supabase
            .from('notifications')
            .update({ lido: true })
            .eq('id', id);
        
        if (error) {
            alert('Erro ao marcar como lida: ' + error.message);
            return;
        }
        
        loadNotifications();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao marcar como lida');
    }
}

// MARCAR TODAS COMO LIDAS
async function markAllAsRead() {
    if (!confirm('Marcar todas as notifica√ß√µes como lidas?')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('notifications')
            .update({ lido: true })
            .eq('user_id', user_id)
            .eq('lido', false);
        
        if (error) {
            alert('Erro ao marcar todas como lidas: ' + error.message);
            return;
        }
        
        alert('Todas as notifica√ß√µes foram marcadas como lidas!');
        loadNotifications();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao marcar todas como lidas');
    }
}

// EXCLUIR NOTIFICA√á√ÉO
async function deleteNotification(id) {
    if (!confirm('Excluir esta notifica√ß√£o?')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('notifications')
            .delete()
            .eq('id', id);
        
        if (error) {
            alert('Erro ao excluir: ' + error.message);
            return;
        }
        
        loadNotifications();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao excluir notifica√ß√£o');
    }
}

// LIMPAR TODAS AS NOTIFICA√á√ïES
async function clearAllNotifications() {
    if (!confirm('Excluir TODAS as notifica√ß√µes? Esta a√ß√£o n√£o pode ser desfeita.')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('notifications')
            .delete()
            .eq('user_id', user_id);
        
        if (error) {
            alert('Erro ao limpar todas: ' + error.message);
            return;
        }
        
        alert('Todas as notifica√ß√µes foram exclu√≠das!');
        loadNotifications();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao limpar notifica√ß√µes');
    }
}

// VER NOTIFICA√á√ÉO (REDIRECIONA)
function viewNotification(id, tipo, referenciaId) {
    // Marca como lida primeiro
    markAsRead(id);
    
    // Redireciona baseado no tipo
    switch(tipo) {
        case 'friend_request':
            window.location.href = 'friends.html';
            break;
        case 'post_like':
        case 'post_comment':
            window.location.href = `post.html?id=${referenciaId}`;
            break;
        case 'group_invite':
            window.location.href = `group.html?id=${referenciaId}`;
            break;
        default:
            // Mant√©m na mesma p√°gina
            loadNotifications();
    }
}

// MOSTRAR ERRO
function showError(message) {
    const container = document.getElementById('notifications-list');
    container.innerHTML = `<div class="empty-notifications" style="color:#f02849;">${message}</div>`;
}

// ATUALIZA√á√ÉO AUTOM√ÅTICA
let refreshInterval = null;

// INICIALIZAR
window.addEventListener('DOMContentLoaded', () => {
    loadNotifications();
    
    // Atualiza a cada 10 segundos
    refreshInterval = setInterval(loadNotifications, 10000);
    
    // Limpa intervalo quando sair da p√°gina
    window.addEventListener('beforeunload', () => {
        if (refreshInterval) clearInterval(refreshInterval);
    });
});
</script>

</body>
</html>
