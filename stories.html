<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FakeBook - Stories</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body { 
    font-family: Arial, sans-serif; 
    background: #f0f2f5; 
    color: #333;
    font-size: 18px;
}

header { 
    background: #1877f2; 
    color: white; 
    padding: 20px; 
    font-size: 28px;
    text-align: center;
}

nav {
    background: white; 
    padding: 15px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

nav a {
    margin: 0 15px;
    color: #1877f2;
    text-decoration: none;
    font-size: 18px;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background 0.3s;
}

nav a:hover {
    background: #f0f2f5;
}

.container {
    max-width: 700px;
    margin: 25px auto;
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.story {
    margin-bottom: 25px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 12px;
    position: relative;
    font-size: 18px;
}

.story img, .story video {
    max-width: 100%;
    border-radius: 10px;
    margin-top: 15px;
}

.story h4 {
    margin: 0 0 10px 0;
    color: #1877f2;
    font-size: 20px;
}

.story p {
    margin: 15px 0;
    font-size: 18px;
    line-height: 1.5;
}

.story-time {
    font-size: 16px;
    color: #666;
    margin-top: 10px;
}

button {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    background: #1877f2;
    color: white;
    cursor: pointer;
    font-size: 18px;
    font-weight: 500;
    margin-top: 10px;
}

button:hover {
    background: #166fe5;
}

.create-story {
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
}

.create-story input, .create-story textarea {
    width: 100%;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 18px;
}

.create-story textarea {
    height: 120px;
    resize: vertical;
}

h3 {
    font-size: 24px;
    color: #1877f2;
    margin-bottom: 20px;
}

.empty-message {
    text-align: center;
    padding: 40px;
    font-size: 20px;
    color: #666;
}
</style>
</head>
<body>

<header>FakeBook - Stories</header>

<nav>
  <a href="feed.html">Feed</a>
  <a href="profile.html">Perfil</a>
  <a href="friends.html">Amigos</a>
  <a href="groups.html">Grupos</a>
  <a href="pages.html">Páginas</a>
  <a href="media.html">Mídia</a>
  <a href="stories.html">Stories</a>
  <a href="settings.html">Configurações</a>
  <a href="login.html">Logout</a>
</nav>

<div class="container">
    <h3>Criar Story</h3>
    <div class="create-story">
        <input type="text" id="story-media" placeholder="URL da imagem ou vídeo">
        <textarea id="story-caption" placeholder="Legenda do story (opcional)"></textarea>
        <button onclick="createStory()">Criar Story</button>
    </div>
    
    <h3>Stories Ativos</h3>
    <div id="stories-list" class="empty-message">Carregando stories...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://umzlriwvexvaabliriva.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtemxyaXd2ZXh2YWFibGlyaXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NjEwMjQsImV4cCI6MjA4MDQzNzAyNH0.8miF7Z0e2sTduJhveCk-6GKzroS0CYF-PS6BZeEKpEI";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const user_id = localStorage.getItem('user_id');
if(!user_id) { 
    alert('Faça login primeiro!');
    window.location.href = 'login.html'; 
}

// CRIAR STORY
async function createStory() {
    const midia_url = document.getElementById('story-media').value.trim();
    const legenda = document.getElementById('story-caption').value.trim();
    
    if (!midia_url) {
        alert('Insira a URL da mídia');
        return;
    }
    
    try {
        // Define expiração para 24 horas
        const expira_em = new Date();
        expira_em.setHours(expira_em.getHours() + 24);
        
        const { error } = await supabase
            .from('stories')
            .insert([{
                user_id: user_id,
                midia_url: midia_url,
                legenda: legenda || null,
                expira_em: expira_em.toISOString()
            }]);
        
        if (error) {
            alert('Erro ao criar story: ' + error.message);
            return;
        }
        
        alert('Story criado com sucesso! Dura 24 horas.');
        
        document.getElementById('story-media').value = '';
        document.getElementById('story-caption').value = '';
        
        loadStories();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao criar story');
    }
}

// CARREGAR STORIES
async function loadStories() {
    const container = document.getElementById('stories-list');
    
    try {
        // Primeiro pega stories do usuário logado
        const { data: userStories, error: userError } = await supabase
            .from('stories')
            .select(`
                id,
                midia_url,
                legenda,
                expira_em,
                criado_em,
                user_id,
                users!inner(nome, sobrenome, username)
            `)
            .eq('user_id', user_id)
            .gt('expira_em', new Date().toISOString()) // Apenas não expirados
            .order('criado_em', { ascending: false });
        
        // Pega stories de outros usuários (simplificado - todos por enquanto)
        const { data: otherStories, error: otherError } = await supabase
            .from('stories')
            .select(`
                id,
                midia_url,
                legenda,
                expira_em,
                criado_em,
                user_id,
                users!inner(nome, sobrenome, username)
            `)
            .neq('user_id', user_id)
            .gt('expira_em', new Date().toISOString())
            .order('criado_em', { ascending: false });
        
        if (userError || otherError) {
            console.error('Erro stories:', userError || otherError);
            container.innerHTML = '<div class="empty-message">Erro ao carregar stories</div>';
            return;
        }
        
        // Combina stories
        const allStories = [...(userStories || []), ...(otherStories || [])];
        
        if (!allStories || allStories.length === 0) {
            container.innerHTML = '<div class="empty-message">Nenhum story ativo no momento</div>';
            return;
        }
        
        container.innerHTML = '';
        
        // Ordena por data mais recente
        allStories.sort((a, b) => new Date(b.criado_em) - new Date(a.criado_em));
        
        allStories.forEach(story => {
            const storyDiv = document.createElement('div');
            storyDiv.className = 'story';
            
            const userName = story.users ? 
                `${story.users.nome || ''} ${story.users.sobrenome || ''}`.trim() || 
                story.users.username || 'Usuário' : 
                'Usuário';
            
            const isMyStory = story.user_id == user_id;
            const storyDate = story.criado_em ? 
                new Date(story.criado_em).toLocaleString('pt-BR') : '';
            
            // Calcula tempo restante
            const now = new Date();
            const expira = new Date(story.expira_em);
            const horasRestantes = Math.max(0, Math.round((expira - now) / (1000 * 60 * 60)));
            
            let mediaHtml = '';
            if (story.midia_url) {
                const isVideo = story.midia_url.match(/\.(mp4|webm|ogg)$/i);
                if (isVideo) {
                    mediaHtml = `<video src="${story.midia_url}" controls style="width:100%;"></video>`;
                } else {
                    mediaHtml = `<img src="${story.midia_url}" style="width:100%; max-height:500px; object-fit:contain;">`;
                }
            }
            
            storyDiv.innerHTML = `
                <h4>${userName} ${isMyStory ? '<span style="font-size:14px; color:#1877f2;">(Você)</span>' : ''}</h4>
                <div class="story-time">
                    Postado: ${storyDate}<br>
                    Expira em: ${horasRestantes} hora${horasRestantes !== 1 ? 's' : ''}
                </div>
                ${mediaHtml}
                ${story.legenda ? `<p><strong>Legenda:</strong> ${story.legenda}</p>` : ''}
                ${isMyStory ? `<button onclick="deleteStory(${story.id})">Excluir Story</button>` : ''}
            `;
            
            container.appendChild(storyDiv);
        });
        
    } catch (err) {
        console.error('Erro:', err);
        container.innerHTML = '<div class="empty-message">Erro ao carregar stories</div>';
    }
}

// EXCLUIR STORY
async function deleteStory(storyId) {
    if (!confirm('Tem certeza que deseja excluir este story?')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('stories')
            .delete()
            .eq('id', storyId)
            .eq('user_id', user_id);
        
        if (error) {
            alert('Erro ao excluir story: ' + error.message);
            return;
        }
        
        alert('Story excluído com sucesso!');
        loadStories();
        
    } catch (err) {
        console.error('Erro:', err);
        alert('Erro ao excluir story');
    }
}

// INICIALIZAR
window.addEventListener('DOMContentLoaded', loadStories);
</script>

</body>
</html>
